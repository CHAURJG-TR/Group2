<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æ•™å®¤åˆ†çµ„ç³»çµ±ï¼ˆé˜²å‘†ï¼šä¸èƒ½åŒçµ„ï¼‰</title>

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- æ‹–æ‹‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
body {
  font-family: "Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:#f4f6f8;
  padding:20px;margin:0;
}
h1{font-size:28px;}
textarea{width:100%;height:100px;font-size:18px;margin-bottom:10px;}
button{font-size:18px;padding:8px 14px;margin:4px;cursor:pointer;}

#stage{margin-top:20px;background:#f4f6f8;padding:10px;}
.stage-board{
  background:#333;color:#fff;text-align:center;
  padding:14px;font-size:28px;margin-bottom:20px;
}
.groups{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.group{
  background:#fff;border-radius:12px;padding:10px;
}
.group h3{text-align:center;margin:0 0 10px;}
.seat{
  background:#e3e7ee;padding:8px;margin:6px 0;
  border-radius:6px;font-size:22px;
  cursor:pointer;text-align:center;
}
.face-row{display:flex;justify-content:space-between;}
.back-seat{text-align:center;margin-top:10px;}
.column-mode .groups{grid-template-columns:1fr;}
.column{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.fullscreen{font-size:34px;}
</style>
</head>
<body>

<h1>æ•™å®¤åˆ†çµ„ç³»çµ±ï¼ˆé˜²å‘†ï¼šä¸èƒ½åŒçµ„ï¼‰</h1>

<h3>ğŸ“‹ ç”·ç”Ÿåå–®ï¼ˆ10 äººï¼‰</h3>
<textarea id="maleList" placeholder="æ¯è¡Œä¸€ä½ç”·ç”Ÿ"></textarea>

<h3>ğŸ“‹ å¥³ç”Ÿåå–®ï¼ˆ10 äººï¼‰</h3>
<textarea id="femaleList" placeholder="æ¯è¡Œä¸€ä½å¥³ç”Ÿ"></textarea>

<h3>ğŸš« ä¸èƒ½åŒçµ„ï¼ˆæ¯è¡Œä¸€çµ„ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šå°æ˜,å°è¯ï¼‰</h3>
<textarea id="banRules" placeholder="å°æ˜,å°è¯"></textarea>

<div>
  <button id="generateBtn" onclick="generate()">ç”Ÿæˆå°çµ„</button>
  <button id="modeBtn" onclick="toggleMode()">ğŸ“Š ç›´æ’æ¨¡å¼</button>
  <button onclick="toggleFullscreen()">ğŸ–¥ï¸ æŠ•å½±æ¨¡å¼</button>
  <button onclick="exportPDF()">ğŸ–¨ï¸ åŒ¯å‡º PDF</button>
  <button onclick="resetAll()">ğŸ”„ é‡è¨­</button>
</div>

<div id="stage"></div>

<script>
let columnMode=false;

// éš¨æ©Ÿæ’åˆ—
function shuffle(arr){return [...arr].sort(()=>Math.random()-0.5);}

// é˜²å‘†åº§ä½å»ºç«‹
function createSeat(name){
  const d=document.createElement("div");
  d.className="seat";
  d.textContent=name;
  d.onclick=()=>{
    const newName=prompt("è«‹è¼¸å…¥æ–°çš„å­¸ç”Ÿå§“åï¼š",d.textContent);
    if(newName===null) return;
    const trimmed=newName.trim();
    if(!trimmed){alert("âŒ å§“åä¸èƒ½æ˜¯ç©ºç™½");return;}
    const seats=document.querySelectorAll(".seat");
    for(const s of seats){if(s!==d && s.textContent===trimmed){alert("âŒ å·²æœ‰ç›¸åŒå§“å");return;}}
    d.textContent=trimmed;
  };
  return d;
}

// ç”Ÿæˆå°çµ„
function generate(){
  const maleStudents=document.getElementById("maleList").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const femaleStudents=document.getElementById("femaleList").value.split("\n").map(s=>s.trim()).filter(Boolean);
  const banRules=document.getElementById("banRules").value.split("\n").map(s=>s.trim()).filter(Boolean).map(line=>line.split(",").map(n=>n.trim()));

  // é˜²å‘†ï¼šäººæ•¸ä¸è¶³
  if(maleStudents.length<10){alert("âŒ ç”·ç”Ÿä¸è¶³ 10 äºº"); return;}
  if(femaleStudents.length<10){alert("âŒ å¥³ç”Ÿä¸è¶³ 10 äºº"); return;}

  // é˜²å‘†ï¼šæª¢æŸ¥ banRules æ˜¯å¦æœ‰ä¸åœ¨åå–®çš„åå­—
  for(const pair of banRules){
    for(const name of pair){
      if(!maleStudents.includes(name) && !femaleStudents.includes(name)){
        alert(`âŒ ã€Œ${name}ã€ä¸åœ¨åå–®ä¸­`);
        return;
      }
    }
  }

  // éš¨æ©Ÿæ’åˆ—
  const males=shuffle(maleStudents);
  const females=shuffle(femaleStudents);

  // æª¢æŸ¥ banRules è¡çª
  const groups=[
    males.slice(0,5),males.slice(5,10),
    females.slice(0,5),females.slice(5,10)
  ];

  for(const pair of banRules){
    for(const group of groups){
      if(pair.every(name=>group.includes(name))){
        alert(`âŒ è¦å‰‡è¡çªï¼š${pair.join("ã€")} åŒçµ„äº†`);
        return;
      }
    }
  }

  renderGroups(groups);
}

// æ¸²æŸ“ 4+1 é¢å°é¢
function renderGroups(groups){
  stage.innerHTML="";
  stage.className = columnMode ? "column-mode" : "";

  // è¬›å°
  const board=document.createElement("div");
  board.className="stage-board";
  board.textContent="ğŸ“¢ è¬›å°";
  stage.appendChild(board);

  const container=document.createElement("div");
  container.className="groups";

  groups.forEach((group,idx)=>{
    const gDiv=document.createElement("div");
    gDiv.className="group";
    const type=(idx<2)?"ç”·ç”Ÿ":"å¥³ç”Ÿ";
    gDiv.innerHTML=`<h3>ç¬¬ ${idx+1} çµ„ (${type})</h3>`;

    const faceRow1=document.createElement("div"); faceRow1.className="face-row";
    const faceRow2=document.createElement("div"); faceRow2.className="face-row";
    for(let i=0;i<2;i++) faceRow1.appendChild(createSeat(group[i]));
    for(let i=0;i<2;i++) faceRow2.appendChild(createSeat(group[i+2]));
    const backSeat=document.createElement("div"); backSeat.className="back-seat";
    backSeat.appendChild(createSeat(group[4]));

    gDiv.appendChild(faceRow1); gDiv.appendChild(faceRow2); gDiv.appendChild(backSeat);
    container.appendChild(gDiv);
  });

  stage.appendChild(container);

  // çµ„å…§æ‹–æ‹‰
  document.querySelectorAll(".group").forEach(g=>{
    new Sortable(g,{animation:150,filter:"h3"});
  });
}

// æ¨¡å¼åˆ‡æ›
function toggleMode(){
  columnMode=!columnMode;
  modeBtn.textContent=columnMode?"ğŸ“Š å°çµ„æ¨¡å¼":"ğŸ“Š ç›´æ’æ¨¡å¼";
  generateBtn.textContent=columnMode?"ç”Ÿæˆç›´æ’":"ç”Ÿæˆå°çµ„";
}

// æŠ•å½±æ¨¡å¼
function toggleFullscreen(){
  if(!document.fullscreenElement){document.documentElement.requestFullscreen();document.body.classList.add("fullscreen");}
  else{document.exitFullscreen();document.body.classList.remove("fullscreen");}
}

// åŒ¯å‡º PDF
function exportPDF(){
  html2canvas(stage,{scale:2}).then(canvas=>{
    const img=canvas.toDataURL("image/png");
    const pdf=new jspdf.jsPDF("p","mm","a4");
    const w=210;
    const h=canvas.height*w/canvas.width;
    pdf.addImage(img,"PNG",0,10,w,h);
    pdf.save("åº§ä½è¡¨.pdf");
  });
}

// é‡è¨­
function resetAll(){ stage.innerHTML=""; }
</script>
</body>
</html>

